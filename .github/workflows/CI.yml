name: CI

on:
  workflow_dispatch:
    inputs:
      Docker:
        description: 'Also push to Docker Hub (requires DOCKERHUB_* secrets)'
        required: false
        default: 'false'
        type: boolean
      Release:
        description: 'Run release-related steps'
        required: false
        default: 'false'
        type: boolean
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  linux:
    name: Build / ${{ matrix.target }}
    runs-on: ubuntu-latest

    # Export secrets into env so we don't reference secrets.* in if: expressions (avoids linter errors)
    env:
      COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      # Constructed image names (these are just strings formed from secrets)
      DOCKERHUB_IMAGE: index.docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}
      GHCR_IMAGE: ghcr.io/${{ github.repository }}

    permissions:
      id-token: write
      contents: write
      attestations: write
      packages: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            platform: linux/amd64
            suffix: ''
            build_env: ''
            variant: linux-amd64
          - target: x86_64-unknown-linux-musl
            platform: linux/amd64
            suffix: '-alpine'
            build_env: ''
            variant: linux-alpine-amd64
          - target: aarch64-unknown-linux-gnu
            platform: linux/arm64
            suffix: ''
            build_env: 'JEMALLOC_SYS_WITH_LG_PAGE=16 '
            variant: linux-arm64
          - target: aarch64-unknown-linux-musl
            platform: linux/arm64
            suffix: '-alpine'
            build_env: 'JEMALLOC_SYS_WITH_LG_PAGE=16 '
            variant: linux-alpine-arm64
          - target: armv7-unknown-linux-gnueabihf
            platform: linux/arm/v7
            suffix: ''
            build_env: 'JEMALLOC_SYS_WITH_LG_PAGE=16 '
            variant: linux-armv7
          - target: armv7-unknown-linux-musleabihf
            platform: linux/arm/v7
            suffix: '-alpine'
            build_env: 'JEMALLOC_SYS_WITH_LG_PAGE=16 '
            variant: linux-alpine-armv7

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Log In to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log In to Docker Hub
        if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
        uses: docker/login-action@v3
        with:
          registry: index.docker.io
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Download build-meta (metadata) for ${{ matrix.variant }}
        uses: actions/download-artifact@v4
        # If artifact is missing (first run / expired), do not fail the whole job.
        continue-on-error: true
        with:
          name: build-meta-${{ matrix.variant }}
          path: ${{ runner.temp }}/${{ matrix.variant }}

      - name: Check whether downloaded metadata exists (diagnostic)
        if: ${{ always() }}
        run: |
          set -euo pipefail
          META_DIR="${{ runner.temp }}/${{ matrix.variant }}"
          if [ -d "$META_DIR" ] && [ "$(ls -A "$META_DIR" 2>/dev/null || true)" ]; then
            echo "Metadata directory $META_DIR exists and contains files."
            ls -la "$META_DIR" || true
          else
            echo "Metadata directory $META_DIR NOT present or empty. Continuing (artifact may not exist)."
          fi

      - name: Download build-meta digests for ${{ matrix.variant }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: build-meta-${{ matrix.variant }}-digests
          path: ${{ runner.temp }}/${{ matrix.variant }}/digests
          pattern: digests-${{ matrix.variant }}-*
          merge-multiple: true

      - name: Create ${matrix.variant} manifest list and push (imagetools)
        working-directory: ${{ runner.temp }}/${{ matrix.variant }}/digests
        run: |
          set -euo pipefail
          if ls >/dev/null 2>&1; then
            echo "Found digest files in $(pwd) â€” attempting manifest list creation (best-effort)."
            # Create GHCR manifest list (best-effort). If nothing matches, imagetools will fail; `|| true` prevents hard failure.
            docker buildx imagetools create $(printf 'ghcr.io/${{ github.repository }}@sha256:%s ' *) || true
            # Create Docker Hub manifest list for your Docker Hub username.
            docker buildx imagetools create $(printf 'index.docker.io/${{ env.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}@sha256:%s ' *) || true
          else
            echo "No digest files found for manifest creation; skipping imagetools create."
          fi

      - name: Inspect ${matrix.variant} image and capture digests
        id: manifest-digest
        run: |
          set -euo pipefail
          META_DIR="${{ runner.temp }}/${{ matrix.variant }}"
          if [ -f "${META_DIR}/bake-meta.json" ]; then
            GHCR_TAG=$(jq -r '.target."docker-metadata-action".tags[0] // empty' "${META_DIR}/bake-meta.json" 2>/dev/null || echo "")
            DOCKERHUB_TAG=$(jq -r '.target."docker-metadata-action".tags[0] // empty' "${META_DIR}/bake-meta.json" 2>/dev/null || echo "")
          else
            GHCR_TAG=""
            DOCKERHUB_TAG=""
          fi

          if [ -n "$GHCR_TAG" ]; then
            echo "Inspecting GHCR image: ghcr.io/${{ github.repository }}:${GHCR_TAG}"
            docker buildx imagetools inspect --format '{{json .Manifest}}' "ghcr.io/${{ github.repository }}:${GHCR_TAG}" | jq -r '.digest' > GHCR_DIGEST_SHA || true
            echo "GHCR_DIGEST_SHA=$(cat GHCR_DIGEST_SHA 2>/dev/null || echo '')" | tee -a "${GITHUB_ENV}"
          fi

          if [ -n "$DOCKERHUB_TAG" ]; then
            echo "Inspecting Docker Hub image: index.docker.io/${{ env.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:${DOCKERHUB_TAG}"
            docker buildx imagetools inspect --format '{{json .Manifest}}' "index.docker.io/${{ env.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:${DOCKERHUB_TAG}" | jq -r '.digest' > DOCKERHUB_DIGEST_SHA || true
            echo "DOCKERHUB_DIGEST_SHA=$(cat DOCKERHUB_DIGEST_SHA 2>/dev/null || echo '')" | tee -a "${GITHUB_ENV}"
          fi

      - name: Attest GHCR
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ghcr.io/${{ github.repository }}
          subject-digest: ${{ env.GHCR_DIGEST_SHA }}
          push-to-registry: true

      - name: Attest Docker Hub
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: index.docker.io/${{ env.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}
          subject-digest: ${{ env.DOCKERHUB_DIGEST_SHA }}
          push-to-registry: true

      - name: Extract Metadata for Docker
        uses: docker/metadata-action@v5
        id: meta
        with:
          images: |
            index.docker.io/${{ env.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}
            ghcr.io/${{ github.repository }}
          flavor: |
            suffix=${{ matrix.suffix }},onlatest=true
          tags: |
            type=ref,event=tag
            type=ref,event=branch,prefix=branch-
            type=edge,branch=main
            type=semver,pattern=v{{major}}.{{minor}}

      - name: Build Artifact (bake)
        id: bake
        uses: docker/bake-action@v6
        env:
          DOCKER_BUILD_RECORD_UPLOAD: false
          TARGET: ${{ matrix.target }}
          GHCR_REPO: ghcr.io/${{ github.repository }}
          BUILD_ENV: ${{ matrix.build_env }}

      - name: Save push digests into files
        run: |
          set -euo pipefail
          REF=${GITHUB_REF_NAME:-${GITHUB_SHA}}
          docker buildx imagetools inspect --format '{{json .Manifest}}' "ghcr.io/${{ github.repository }}:${REF}" | jq -r '.digest' > GHCR_DIGEST_SHA || true
          echo "GHCR_DIGEST_SHA=$(cat GHCR_DIGEST_SHA 2>/dev/null || echo '')" | tee -a "${GITHUB_ENV}"
          docker buildx imagetools inspect --format '{{json .Manifest}}' "index.docker.io/${{ env.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:${REF}" | jq -r '.digest' > DOCKERHUB_DIGEST_SHA || true
          echo "DOCKERHUB_DIGEST_SHA=$(cat DOCKERHUB_DIGEST_SHA 2>/dev/null || echo '')" | tee -a "${GITHUB_ENV}"

      - name: Sign GHCR images with cosign
        if: ${{ env.COSIGN_PASSWORD != '' }}
        env:
          COSIGN_PASSWORD: ${{ env.COSIGN_PASSWORD }}
        run: |
          set -euo pipefail
          REF=${GITHUB_REF_NAME:-${GITHUB_SHA}}
          IMAGE="ghcr.io/${{ github.repository }}:${REF}"
          echo "Signing ${IMAGE} with cosign..."
          cosign sign --yes "${IMAGE}"

      - name: Sign Docker Hub images with cosign
        if: ${{ env.COSIGN_PASSWORD != '' && env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        env:
          COSIGN_PASSWORD: ${{ env.COSIGN_PASSWORD }}
        run: |
          set -euo pipefail
          REF=${GITHUB_REF_NAME:-${GITHUB_SHA}}
          IMAGE="index.docker.io/${{ env.DOCKERHUB_USERNAME }}/${{ github.event.repository.name }}:${REF}"
          echo "Signing ${IMAGE} with cosign..."
          cosign sign --yes "${IMAGE}"

      - name: Upload build metadata artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-meta-${{ matrix.variant }}
          path: |
            ${{ github.workspace }}/target || true
            ${{ github.workspace }}/build-info || true

  linux_extra:
    runs-on: ubuntu-latest
    needs: [linux]
    if: ${{ github.event_name == 'push' || github.event.inputs.Docker == 'true' }}
    permissions:
      id-token: write
      contents: read
      attestations: write
      packages: write
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Log In to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log In to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: index.docker.io
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Calculate shasum of external artifacts
        run: |
          # (preserve your original shasum steps)
          echo "placeholder for shasum steps"

      - name: Upload external artifacts
        uses: actions/upload-artifact@v4
        with:
          name: external-artifacts
          path: |
            archive/**/*.tar.gz
            archive/**/*.zip

  release:
    runs-on: ubuntu-latest
    needs: [linux]
    if: ${{ github.event_name == 'push' || github.event.inputs.Docker == 'true' }}
    permissions:
      contents: read
      packages: write
      id-token: write
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Log In to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log In to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: index.docker.io
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Create release notes (placeholder)
        run: |
          echo "Release job triggered for tag ${GITHUB_REF_NAME:-${GITHUB_REF##*/}}"
 
